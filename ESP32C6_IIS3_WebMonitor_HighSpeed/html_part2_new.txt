        "';(function(){\n  const statusBox=document.getElementById('status');\n  const statusText=d"
        "ocument.getElementById('statusText');\n  const statusIp=document.getElementById('statusIp'"
        ");\n  statusIp.textContent='IP: '+ESP32_IP;\n  const logEl=document.getElementById('log');"
        "\n  function addLog(msg){const t=new Date().toLocaleTimeString();logEl.innerHTML='['+t+'] "
        "'+msg+'<br>'+logEl.innerHTML;const parts=logEl.innerHTML.split('<br>');if(parts.length>160"
        "){logEl.innerHTML=parts.slice(0,160).join('<br>');}}\n  addLog('Device IP: '+ESP32_IP);\n "
        " const metrics={msg:document.getElementById('metricMsg'),samples:document.getElementById('"
        "metricSamples'),fifo:document.getElementById('metricFifo'),batch:document.getElementById('"
        "metricBatch'),mag:document.getElementById('metricMag'),fs:document.getElementById('metricF"
        "s')};\n  const canvas=document.getElementById('chartG');\n  const ctx=canvas.getContext('2"
        "d');\n  const dpr=window.devicePixelRatio||1;\n  const maxPoints=200;\n  const buffers={x:"
        "[],y:[],z:[]};\n  let selectedScale='auto';\n  let manualScale=2;\n  let drawHandle=null;\n"
        "  function resizeCanvas(){const width=canvas.clientWidth||canvas.width;const height=canvas"
        ".clientHeight||canvas.height;canvas.width=Math.max(1,width*dpr);canvas.height=Math.max(1,h"
        "eight*dpr);ctx.setTransform(dpr,0,0,dpr,0,0); scheduleDraw();}\n  window.addEventListener("
        "'resize',()=>resizeCanvas());\n  resizeCanvas();\n  function formatNumber(val,digits){if(v"
        "al===null||val===undefined||!isFinite(val))return '-';return Number(val).toFixed(digits);}"
        "\n  function computeRange(){if(selectedScale!=='auto'){return [-manualScale,manualScale];}"
        "let min=Infinity;let max=-Infinity;for(const key of ['x','y','z']){for(const val of buffer"
        "s[key]){if(!Number.isFinite(val))continue;if(val<min)min=val;if(val>max)max=val;}}if(!Numb"
        "er.isFinite(min)||!Number.isFinite(max)){return [-1,1];}if(min===max){const pad=Math.max(M"
        "ath.abs(min)*0.1,0.1);return [min-pad,min+pad];}const span=max-min;const pad=span*0.1||0.1"
        ";return [min-pad,max+pad];}\n  function scheduleDraw(){if(drawHandle!==null)return;drawHan"
        "dle=requestAnimationFrame(()=>{drawHandle=null;drawChart();});}\n  function drawChart(){co"
        "nst width=canvas.clientWidth||canvas.width/dpr;const height=canvas.clientHeight||canvas.he"
        "ight/dpr;ctx.setTransform(dpr,0,0,dpr,0,0);ctx.clearRect(0,0,width,height);ctx.fillStyle='"
        "#f8fafc';ctx.fillRect(0,0,width,height);const [minVal,maxVal]=computeRange();const span=ma"
        "xVal-minVal||1;const colors={x:'#ef4444',y:'#10b981',z:'#3b82f6'};const gridCount=4;ctx.st"
        "rokeStyle='rgba(148,163,184,0.3)';ctx.lineWidth=1;ctx.font='11px sans-serif';ctx.fillStyle"
        "='#475569';for(let i=0;i<=gridCount;i++){const ratio=i/gridCount;const y=height - ratio*he"
        "ight;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(width,y);ctx.stroke();const value=maxVal -"
        " ratio*span;ctx.fillText(formatNumber(value,2),4,Math.min(height-4,Math.max(12,y-2)));}ctx"
        ".lineWidth=1.4;for(const key of ['x','y','z']){const data=buffers[key];if(data.length<2)co"
        "ntinue;ctx.strokeStyle=colors[key];ctx.beginPath();for(let i=0;i<data.length;i++){const x="
        "(i/(maxPoints-1))*width;const val=data[i];const ratio=(val-minVal)/span;const y=height - r"
        "atio*height;if(i===0){ctx.moveTo(x,y);}else{ctx.lineTo(x,y);}}ctx.stroke();}}\n  const sca"
        "leControls=document.getElementById('scaleControls');\n  const scaleButtons=scaleControls?A"
        "rray.from(scaleControls.querySelectorAll('button')):[];\n  function applyScale(mode,opts){"
        "const options=opts||{};selectedScale=mode;if(mode!=='auto'){const parsed=Number(mode);if(!"
        "Number.isFinite(parsed)){addLog('Invalid scale '+mode);return;}manualScale=parsed;}if(scal"
        "eButtons.length){scaleButtons.forEach(btn=>btn.classList.toggle('active',btn.dataset.scale"
        "===mode));}if(mode==='auto'){metrics.fs.textContent='auto';}else{metrics.fs.textContent='+"
        "/-'+manualScale+'g';}if(!options.silent){addLog('Chart scale set to '+(mode==='auto'?'auto"
        "':('+/-'+manualScale+'g')));}scheduleDraw();}\n  if(scaleButtons.length){applyScale('auto'"
        ",{silent:true});scaleButtons.forEach(btn=>{btn.addEventListener('click',()=>{const target="
        "btn.dataset.scale;if(target==='auto'){applyScale('auto');return;}if(selectedScale===target"
        ")return;scaleButtons.forEach(b=>b.classList.remove('loading'));btn.classList.add('loading'"
        ");fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON"
        ".stringify({full_scale_g:Number(target)})}).then(resp=>{if(!resp.ok)throw new Error('HTTP "
        "'+resp.status);return resp.json();}).then(cfg=>{const applied=cfg&&cfg.full_scale_g?String"
        "(cfg.full_scale_g):target;applyScale(applied,{silent:true});}).catch(err=>{addLog('Scale u"
        "pdate failed: '+err.message);}).finally(()=>{btn.classList.remove('loading');});});});}els"
        "e{applyScale('auto',{silent:true});}\n  function refreshConfig(){fetch('/api/config').then"
        "(resp=>{if(!resp.ok)throw new Error('HTTP '+resp.status);return resp.json();}).then(cfg=>{"
        "if(cfg&&cfg.imu_full_scale_g){const fsVal=String(cfg.imu_full_scale_g);if(selectedScale==="
        "'auto'){metrics.fs.textContent='+/-'+fsVal+'g';}else{applyScale(fsVal,{silent:true});}}})."
        "catch(err=>{addLog('Config fetch failed: '+err.message);});}\n  refreshConfig();\n  functi"
        "on pushValues(payload){if(!payload||!payload.chunks)return;const chunk=payload.chunks;cons"
        "t xs=Array.isArray(chunk.x)?chunk.x:[];const ys=Array.isArray(chunk.y)?chunk.y:[];const zs"
        "=Array.isArray(chunk.z)?chunk.z:[];const len=Math.min(xs.length,ys.length,zs.length);if(!l"
        "en)return;for(let i=0;i<len;i++){if(buffers.x.length>=maxPoints){buffers.x.shift();buffers"
        ".y.shift();buffers.z.shift();}buffers.x.push(Number(xs[i]));buffers.y.push(Number(ys[i]));"
        "buffers.z.push(Number(zs[i]));}scheduleDraw();if(payload.mag!==undefined){metrics.mag.text"
        "Content=formatNumber(payload.mag,3);}if(payload.fs!==undefined&&selectedScale==='auto'){me"
        "trics.fs.textContent='+/-'+payload.fs+'g';}}\n  function updateMetrics(payload){const stat"
        "s=payload&&payload.s?payload.s:{};const plotRate=formatNumber(stats.pps!==undefined?stats."
        "pps:(stats.mps!==undefined?stats.mps:0),1);metrics.msg.textContent=plotRate;metrics.sample"
        "s.textContent=formatNumber(stats.sps,0);metrics.fifo.textContent=stats.fifo!==undefined?st"
        "ats.fifo:'-';metrics.batch.textContent=stats.batch!==undefined?stats.batch:'-';if(payload&"
        "&payload.mag!==undefined){metrics.mag.textContent=formatNumber(payload.mag,3);}statusText."
        "textContent='Connected - '+plotRate+' pts/s';statusBox.style.borderLeftColor='#10b981';sta"
        "tusBox.style.background='#fff';}\n  addLog('Waiting for IIS3DWB data...');\n  const wsUrl="
        "(location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws/data';\n  addLog('Conne"
        "cting to '+wsUrl);\n  const ws=new WebSocket(wsUrl);\n  ws.onopen=()=>{addLog('WebSocket c"
        "onnected from '+ESP32_IP);statusText.textContent='Connected';statusBox.style.borderLeftCol"
        "or='#10b981';statusBox.style.background='#fff';};\n  ws.onerror=()=>{addLog('WebSocket err"
        "or');statusText.textContent='Error';statusBox.style.borderLeftColor='#ef4444';statusBox.st"
        "yle.background='#fef2f2';};\n  ws.onclose=()=>{addLog('WebSocket closed');statusText.textC"
        "ontent='Disconnected';statusBox.style.borderLeftColor='#f59e0b';statusBox.style.background"
        "='#fffbeb';};\n  ws.onmessage=ev=>{try{const payload=JSON.parse(ev.data);pushValues(payloa"
        "d);updateMetrics(payload);}catch(err){addLog('Parse error: '+err.message);}};})();</script"
        "></body></html>\";"
